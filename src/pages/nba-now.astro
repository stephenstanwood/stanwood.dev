---
import "../styles/global.css";
const title = "NBA Now — stanwood.dev";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta
      name="description"
      content="The best NBA game to watch right now."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', system-ui, sans-serif;
        background: #050508;
        color: #d4d4d8;
        min-height: 100vh;
      }

      .font-score {
        font-family: 'Orbitron', monospace;
      }

      /* Neon glow colors */
      .neon-orange { color: #ff6b2b; text-shadow: 0 0 10px rgba(255, 107, 43, 0.5), 0 0 20px rgba(255, 107, 43, 0.2); }
      .neon-cyan { color: #22d3ee; text-shadow: 0 0 10px rgba(34, 211, 238, 0.5), 0 0 20px rgba(34, 211, 238, 0.2); }
      .neon-red { color: #ff3b5c; text-shadow: 0 0 10px rgba(255, 59, 92, 0.5); }
      .neon-dim { color: #52525b; text-shadow: none; }
      .neon-amber { color: #f59e0b; text-shadow: 0 0 8px rgba(245, 158, 11, 0.4); }

      /* Live pulse */
      @keyframes pulse-live {
        0%, 100% { opacity: 1; box-shadow: 0 0 6px #ff3b5c; }
        50% { opacity: 0.4; box-shadow: 0 0 2px #ff3b5c; }
      }
      .live-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ff3b5c;
        animation: pulse-live 1.5s ease-in-out infinite;
      }

      /* Skeleton loader */
      @keyframes shimmer {
        0% { background-position: -400px 0; }
        100% { background-position: 400px 0; }
      }
      .skeleton {
        background: linear-gradient(90deg, #111118 25%, #1a1a28 50%, #111118 75%);
        background-size: 800px 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 6px;
      }

      /* Watch score bar */
      .watch-bar-track {
        height: 3px;
        border-radius: 2px;
        background: #18181b;
        overflow: hidden;
      }
      .watch-bar-fill {
        height: 100%;
        border-radius: 2px;
        background: linear-gradient(90deg, #ff6b2b, #22d3ee);
        transition: width 0.6s ease-out;
      }

      /* Hero card — scoreboard style */
      .hero-card {
        background: linear-gradient(160deg, #0c0c14 0%, #12121e 100%);
        border: 1px solid #1f1f30;
        border-radius: 12px;
        box-shadow: 0 0 60px rgba(255, 107, 43, 0.05), inset 0 1px 0 rgba(255,255,255,0.03);
      }

      /* Game rows */
      .game-row {
        background: #0a0a12;
        border: 1px solid #18181f;
        border-radius: 10px;
        transition: border-color 0.2s;
      }
      .game-row:hover {
        border-color: #2a2a3a;
      }

      /* Broadcast badges */
      .broadcast-badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        font-family: 'Inter', sans-serif;
        font-size: 9px;
        font-weight: 600;
        letter-spacing: 0.03em;
        padding: 2px 5px;
        border-radius: 3px;
        white-space: nowrap;
        line-height: 1;
      }
      .broadcast-badge.national {
        background: rgba(255, 107, 43, 0.12);
        color: #ff8c55;
        border: 1px solid rgba(255, 107, 43, 0.2);
      }
      .broadcast-badge.local {
        background: rgba(63, 63, 70, 0.3);
        color: #52525b;
        border: 1px solid rgba(63, 63, 70, 0.3);
      }

      /* Subtle scanline effect on hero */
      .hero-card::after {
        content: '';
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(255,255,255,0.008) 2px,
          rgba(255,255,255,0.008) 4px
        );
        border-radius: 12px;
        pointer-events: none;
      }
      .hero-card { position: relative; overflow: hidden; }

      /* Scoreboard section dividers */
      .scoreboard-divider {
        border: none;
        height: 1px;
        background: linear-gradient(90deg, transparent, #2a2a3a 20%, #2a2a3a 80%, transparent);
        margin: 0;
      }

      /* Section header — retro LED style */
      .section-header {
        font-family: 'Orbitron', monospace;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: #f59e0b;
        text-shadow: 0 0 8px rgba(245, 158, 11, 0.3);
        text-align: center;
        padding: 12px 0 8px;
        position: relative;
      }
      .section-header::before,
      .section-header::after {
        content: '';
        position: absolute;
        top: 50%;
        width: 60px;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.3));
      }
      .section-header::before { right: calc(50% + 80px); transform: rotate(180deg); }
      .section-header::after { left: calc(50% + 80px); }

      /* Retro dot grid on game rows */
      .game-row::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: radial-gradient(circle, rgba(255, 255, 255, 0.015) 1px, transparent 1px);
        background-size: 8px 8px;
        border-radius: 10px;
        pointer-events: none;
      }
      .game-row { position: relative; overflow: hidden; }

      /* Subtitle styling */
      .subtitle {
        font-family: 'Orbitron', monospace;
        font-size: 10px;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: #a1a1aa;
        text-shadow: 0 0 6px rgba(161, 161, 170, 0.2);
      }
    </style>
  </head>

  <body class="antialiased">
    <main class="mx-auto max-w-lg px-5 pt-12 pb-24">
      <div>
        <a
          href="/"
          class="text-xs font-medium uppercase tracking-wider transition-colors"
          style="color: #3f3f46;"
          onmouseover="this.style.color='#a1a1aa'"
          onmouseout="this.style.color='#3f3f46'"
        >
          &larr; Home
        </a>
      </div>

      <header class="mt-6 text-center">
        <h1 class="font-score text-2xl font-bold tracking-widest neon-orange">
          NBA NOW
        </h1>
        <p class="mt-1.5 subtitle">
          The best game to watch right now
        </p>
      </header>

      <div id="app" class="mt-8">
        <!-- Loading skeleton -->
        <div id="loading">
          <div class="hero-card p-6">
            <div class="skeleton mx-auto" style="width: 100px; height: 12px;"></div>
            <div class="mt-6 space-y-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="skeleton" style="width: 32px; height: 32px; border-radius: 50%;"></div>
                  <div class="skeleton" style="width: 50px; height: 20px;"></div>
                </div>
                <div class="skeleton" style="width: 60px; height: 32px;"></div>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="skeleton" style="width: 32px; height: 32px; border-radius: 50%;"></div>
                  <div class="skeleton" style="width: 50px; height: 20px;"></div>
                </div>
                <div class="skeleton" style="width: 60px; height: 32px;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main content (hidden until loaded) -->
        <div id="content" style="display: none;"></div>

        <!-- Error state -->
        <div id="error" style="display: none;"></div>
      </div>
    </main>

    <script>
      const API_URL = "https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard";
      const REFRESH_MS = 30_000;

      // --- Ranking algorithm ---

      function parseRecord(competitor) {
        const rec = competitor?.records?.[0];
        if (!rec) return { wins: 0, losses: 0 };
        if (rec.summary) {
          const [w, l] = rec.summary.split("-").map(Number);
          if (!isNaN(w) && !isNaN(l)) return { wins: w, losses: l };
        }
        return { wins: 0, losses: 0 };
      }

      function winPct({ wins, losses }) {
        const total = wins + losses;
        return total > 0 ? wins / total : 0.5;
      }

      function gameProgress(status) {
        const period = status?.period || 0;
        const clockStr = status?.displayClock || "12:00";
        const [minStr, secStr] = clockStr.split(":");
        const minutes = parseFloat(minStr || 0);
        const seconds = parseFloat(secStr || 0);
        const clockMinutes = minutes + seconds / 60;

        if (period === 0) return 0;

        const quarterElapsed = 12 - clockMinutes;
        const totalElapsed = (period - 1) * 12 + quarterElapsed;
        return Math.max(0, totalElapsed / 48);
      }

      function isOvertime(status) {
        return (status?.period || 0) > 4;
      }

      function computeWatchScore(game) {
        const comp = game.competitions?.[0];
        if (!comp) return 0;

        const competitors = comp.competitors || [];
        if (competitors.length < 2) return 0;

        const score1 = parseInt(competitors[0].score || 0, 10);
        const score2 = parseInt(competitors[1].score || 0, 10);
        const scoreDelta = Math.abs(score1 - score2);

        const rec1 = parseRecord(competitors[0]);
        const rec2 = parseRecord(competitors[1]);
        const avgWinPct = (winPct(rec1) + winPct(rec2)) / 2;

        const status = comp.status;
        const progress = gameProgress(status);
        const ot = isOvertime(status);

        const closenessScore = Math.max(0, 100 - scoreDelta * 4);
        const qualityMultiplier = 0.5 + avgWinPct;
        const progressMultiplier = ot ? 3.5 : 1.0 + Math.min(progress, 1.0) * 2.0;

        return closenessScore * qualityMultiplier * progressMultiplier;
      }

      // For pre-game: rank by team quality only (avg win %)
      function computePreGameScore(game) {
        const comp = game.competitions?.[0];
        if (!comp) return 0;
        const competitors = comp.competitors || [];
        if (competitors.length < 2) return 0;

        const rec1 = parseRecord(competitors[0]);
        const rec2 = parseRecord(competitors[1]);
        const avgWinPct = (winPct(rec1) + winPct(rec2)) / 2;

        // Also reward closeness of records (competitive matchup)
        const diff = Math.abs(winPct(rec1) - winPct(rec2));
        const matchupBonus = 1.0 - diff; // 1.0 for equal teams, lower for mismatches

        return avgWinPct * 100 * matchupBonus;
      }

      // --- Broadcast helpers ---

      function getBroadcasts(competition) {
        const geo = competition?.geoBroadcasts || [];
        const national = geo
          .filter(b => b.market?.type === "National")
          .map(b => b.media?.shortName)
          .filter(Boolean);
        const local = geo
          .filter(b => b.market?.type !== "National")
          .map(b => b.media?.shortName)
          .filter(Boolean);
        // Dedupe
        return {
          national: [...new Set(national)],
          local: [...new Set(local)],
        };
      }

      function renderBroadcastBadges(competition, compact) {
        const { national } = getBroadcasts(competition);

        const nationalStyle = "display:inline-flex;align-items:center;font-family:Inter,sans-serif;font-size:9px;font-weight:600;letter-spacing:0.03em;padding:2px 5px;border-radius:3px;white-space:nowrap;line-height:1;background:rgba(255,107,43,0.12);color:#ff8c55;border:1px solid rgba(255,107,43,0.2);";
        const leaguePassStyle = "display:inline-flex;align-items:center;font-family:Inter,sans-serif;font-size:9px;font-weight:600;letter-spacing:0.03em;padding:2px 5px;border-radius:3px;white-space:nowrap;line-height:1;background:rgba(63,63,70,0.3);color:#71717a;border:1px solid rgba(63,63,70,0.4);";

        let badge;
        if (national.length > 0) {
          badge = `<span style="${nationalStyle}">${national[0]}</span>`;
        } else {
          badge = `<span style="${leaguePassStyle}">League Pass</span>`;
        }

        return `<div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;justify-content:${compact ? 'flex-end' : 'center'};${compact ? '' : 'margin-top:8px;'}">${badge}</div>`;
      }

      // --- Rendering ---

      function teamAbbr(competitor) {
        return competitor?.team?.abbreviation || "???";
      }

      function teamColor(competitor) {
        return competitor?.team?.color ? `#${competitor.team.color}` : "#ff6b2b";
      }

      function statusLabel(status) {
        const period = status?.period || 0;
        const clock = status?.displayClock || "";
        const desc = status?.type?.description || "";

        if (desc === "Final") return "FINAL";
        if (desc === "Halftime") return "HALF";
        if (period === 0) return "";
        if (period > 4) return `OT${period - 4} ${clock}`;
        return `Q${period} ${clock}`;
      }

      function isLive(status) {
        return (status?.type?.state || "") === "in";
      }

      function formatTipoff(dateStr) {
        return new Date(dateStr).toLocaleTimeString("en-US", {
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
          timeZone: "America/Los_Angeles",
        });
      }

      function renderHeroCard(game) {
        const comp = game.competitions?.[0];
        const competitors = comp?.competitors || [];
        const status = comp?.status;
        const live = isLive(status);
        const watchScore = computeWatchScore(game);
        const maxScore = 400;

        const away = competitors.find(c => c.homeAway === "away") || competitors[0];
        const home = competitors.find(c => c.homeAway === "home") || competitors[1];
        const barPct = Math.min(100, Math.round((watchScore / maxScore) * 100));

        return `
          <div class="hero-card p-5">
            <div class="flex items-center justify-center gap-2 text-xs font-score font-medium uppercase tracking-widest">
              ${live ? '<div class="live-dot"></div><span class="neon-red">Live</span><span style="color:#27272a;">·</span>' : ''}
              <span class="neon-cyan">${statusLabel(status)}</span>
            </div>

            <div class="mt-5 space-y-2">
              ${renderHeroTeam(away, status)}
              <div style="border-top: 1px solid #18181b;"></div>
              ${renderHeroTeam(home, status)}
            </div>

            <div class="flex justify-center">${renderBroadcastBadges(comp, false)}</div>

            <div class="mt-3">
              <div class="watch-bar-track">
                <div class="watch-bar-fill" style="width: ${barPct}%;"></div>
              </div>
              <div class="mt-1 text-center font-score text-xs neon-dim">${Math.round(watchScore)}</div>
            </div>
          </div>
        `;
      }

      function renderHeroTeam(competitor, status) {
        const abbr = teamAbbr(competitor);
        const record = competitor?.records?.[0]?.summary || "";
        const logoUrl = competitor?.team?.logo;
        const color = teamColor(competitor);
        const state = status?.type?.state;
        const showScore = state && state !== "pre";
        const score = showScore ? (competitor?.score ?? "–") : "";

        return `
          <div class="flex items-center justify-between py-1">
            <div class="flex items-center gap-3">
              ${logoUrl
                ? `<img src="${logoUrl}" alt="${abbr}" width="28" height="28" style="object-fit: contain;" />`
                : `<div style="width:28px;height:28px;border-radius:50%;background:${color};"></div>`
              }
              <div>
                <div class="font-score text-sm font-bold tracking-wider" style="color: #fafafa;">${abbr}</div>
                <div class="text-xs" style="color: #71717a;">${record}</div>
              </div>
            </div>
            ${score ? `<div class="font-score text-3xl font-black tracking-wider neon-orange">${score}</div>` : ''}
          </div>
        `;
      }

      function renderGameRow(game, rank, isPreGame) {
        const comp = game.competitions?.[0];
        const competitors = comp?.competitors || [];
        const status = comp?.status;
        const live = isLive(status);

        const away = competitors.find(c => c.homeAway === "away") || competitors[0];
        const home = competitors.find(c => c.homeAway === "home") || competitors[1];

        const awayScore = away?.score ?? "";
        const homeScore = home?.score ?? "";
        const awayAbbr = teamAbbr(away);
        const homeAbbr = teamAbbr(home);
        const awayLogo = away?.team?.logo;
        const homeLogo = home?.team?.logo;
        const awayColor = teamColor(away);
        const homeColor = teamColor(home);

        const showScores = !isPreGame;
        const tipoff = isPreGame ? formatTipoff(game.date) : "";
        const statusText = isPreGame ? tipoff + " PT" : statusLabel(status);

        return `
          <div class="game-row px-3 py-2.5" style="display:flex;align-items:center;">
            <div style="font-family:Orbitron,monospace;font-size:10px;color:#52525b;width:24px;text-align:right;flex-shrink:0;margin-right:16px;">${rank}</div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  ${awayLogo
                    ? `<img src="${awayLogo}" alt="${awayAbbr}" width="16" height="16" style="object-fit:contain;" />`
                    : `<div style="width:16px;height:16px;border-radius:50%;background:${awayColor};"></div>`
                  }
                  <span class="font-score text-xs font-semibold tracking-wider" style="color:#e4e4e7;">${awayAbbr}</span>
                </div>
                ${showScores ? `<span class="font-score text-sm font-bold tracking-wider" style="color:#fafafa;">${awayScore}</span>` : ''}
              </div>
              <div class="flex items-center justify-between mt-0.5">
                <div class="flex items-center gap-2">
                  ${homeLogo
                    ? `<img src="${homeLogo}" alt="${homeAbbr}" width="16" height="16" style="object-fit:contain;" />`
                    : `<div style="width:16px;height:16px;border-radius:50%;background:${homeColor};"></div>`
                  }
                  <span class="font-score text-xs font-semibold tracking-wider" style="color:#e4e4e7;">${homeAbbr}</span>
                </div>
                ${showScores ? `<span class="font-score text-sm font-bold tracking-wider" style="color:#fafafa;">${homeScore}</span>` : ''}
              </div>
            </div>
            <div class="text-right flex-shrink-0" style="min-width: 70px;">
              <div class="flex items-center justify-end gap-1">
                ${live ? '<div class="live-dot" style="width:5px;height:5px;"></div>' : ''}
                <span class="font-score text-xs ${live ? 'neon-cyan' : ''}" style="${!live ? 'color:#a1a1aa;' : ''}">${statusText}</span>
              </div>
              ${renderBroadcastBadges(comp, true)}
            </div>
          </div>
        `;
      }

      function renderNoGames(events) {
        const scheduled = events
          .filter(e => e.competitions?.[0]?.status?.type?.state === "pre")
          .sort((a, b) => new Date(a.date) - new Date(b.date));

        let nextLine = "";
        if (scheduled.length > 0) {
          const next = scheduled[0];
          const comp = next.competitions?.[0];
          const away = comp?.competitors?.find(c => c.homeAway === "away");
          const home = comp?.competitors?.find(c => c.homeAway === "home");
          const time = formatTipoff(next.date);
          nextLine = `
            <div class="mt-4 font-score text-sm" style="color: #a1a1aa;">
              Next up: <span style="color: #22d3ee; text-shadow: 0 0 8px rgba(34, 211, 238, 0.3);">${teamAbbr(away)} @ ${teamAbbr(home)}</span>
              <span style="color: #f59e0b; text-shadow: 0 0 6px rgba(245, 158, 11, 0.3); margin-left: 4px;">${time} PT</span>
            </div>
          `;
        }

        const message = events.length === 0
          ? "NO GAMES"
          : "NO LIVE GAMES";

        return `
          <div class="hero-card p-8 text-center">
            <div class="font-score text-lg font-bold tracking-widest" style="color: #a1a1aa; text-shadow: 0 0 10px rgba(161, 161, 170, 0.2);">${message}</div>
            ${nextLine}
          </div>
        `;
      }

      function getGameDayLabel(events) {
        // Figure out if these games are today, tomorrow, or another day
        const firstGame = events.find(e => e.date);
        if (!firstGame) return "Games";

        const gameDate = new Date(firstGame.date);
        const now = new Date();
        const pt = "America/Los_Angeles";

        const gameDayStr = gameDate.toLocaleDateString("en-US", { timeZone: pt, year: "numeric", month: "2-digit", day: "2-digit" });
        const todayStr = now.toLocaleDateString("en-US", { timeZone: pt, year: "numeric", month: "2-digit", day: "2-digit" });

        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = tomorrow.toLocaleDateString("en-US", { timeZone: pt, year: "numeric", month: "2-digit", day: "2-digit" });

        if (gameDayStr === todayStr) return "Today's Games";
        if (gameDayStr === tomorrowStr) return "Tomorrow's Games";

        // Fallback: show the day name
        const dayName = gameDate.toLocaleDateString("en-US", { timeZone: pt, weekday: "long" });
        return `${dayName}'s Games`;
      }

      function renderRankedGames(events, sectionTitle) {
        // Get all non-final games and rank them
        const preGames = events
          .filter(e => e.competitions?.[0]?.status?.type?.state === "pre")
          .map(g => ({ game: g, score: computePreGameScore(g) }))
          .sort((a, b) => b.score - a.score);

        if (preGames.length === 0) return "";

        return `
          <div class="section-header mt-8 mb-3">${sectionTitle}</div>
          <div class="space-y-1.5">
            ${preGames.map((g, i) => renderGameRow(g.game, i + 1, true)).join("")}
          </div>
        `;
      }

      function render(events) {
        const content = document.getElementById("content");

        const liveGames = events.filter(e => {
          const state = e.competitions?.[0]?.status?.type?.state;
          return state === "in";
        });

        const dayLabel = getGameDayLabel(events);

        if (liveGames.length === 0) {
          content.innerHTML = renderNoGames(events) + renderRankedGames(events, dayLabel);
          return;
        }

        // Rank live games
        const ranked = liveGames
          .map(g => ({ game: g, score: computeWatchScore(g) }))
          .sort((a, b) => b.score - a.score);

        const best = ranked[0];
        const others = ranked.slice(1);

        let html = renderHeroCard(best.game);

        if (others.length > 0) {
          html += `
            <div class="section-header mt-6 mb-3">Also Live</div>
            <div class="space-y-1.5">
              ${others.map((o, i) => renderGameRow(o.game, i + 2, false)).join("")}
            </div>
          `;
        }

        html += renderRankedGames(events, "Coming Up");

        content.innerHTML = html;
      }

      // --- Fetch + loop ---

      async function fetchAndRender() {
        const loading = document.getElementById("loading");
        const content = document.getElementById("content");
        const errorEl = document.getElementById("error");

        try {
          const res = await fetch(API_URL);
          if (!res.ok) throw new Error(`ESPN returned ${res.status}`);
          const data = await res.json();
          const events = data?.events || [];

          loading.style.display = "none";
          errorEl.style.display = "none";
          content.style.display = "block";

          render(events);
        } catch (err) {
          loading.style.display = "none";
          content.style.display = "none";
          errorEl.style.display = "block";
          errorEl.innerHTML = `
            <div class="hero-card p-6 text-center">
              <div class="font-score text-xs neon-red">
                ${err.message}
              </div>
              <button
                onclick="fetchAndRender()"
                class="mt-3 font-score text-xs font-semibold px-4 py-2 rounded-lg"
                style="background: #111118; color: #ff6b2b; border: 1px solid #1f1f30; cursor: pointer;"
              >
                RETRY
              </button>
            </div>
          `;
        }
      }

      fetchAndRender();
      setInterval(fetchAndRender, REFRESH_MS);
    </script>
  </body>
</html>
