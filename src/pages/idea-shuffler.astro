---
import "../styles/global.css";
const title = "Idea Shuffler â€” stanwood.dev";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta
      name="description"
      content="Browse ideas without ranking them. Random start + circular traversal."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Space Grotesk', system-ui, sans-serif;
        background-color: #FFF8F0;
        background-image: radial-gradient(circle, #e0d5c8 1px, transparent 1px);
        background-size: 24px 24px;
      }

      /* ---- Rolodex card ---- */
      .rolodex-wrapper {
        perspective: 800px;
      }

      .rolodex-card {
        cursor: pointer;
        user-select: none;
        transform-origin: center center;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .rolodex-card:hover {
        transform: rotate(-1deg) scale(1.01);
        box-shadow: 8px 8px 0 #222;
      }

      /* Flip down (next) */
      @keyframes flipDown {
        0%   { transform: rotateX(0deg);   opacity: 1; }
        40%  { transform: rotateX(-90deg); opacity: 0; }
        60%  { transform: rotateX(90deg);  opacity: 0; }
        100% { transform: rotateX(0deg);   opacity: 1; }
      }
      /* Flip up (prev) */
      @keyframes flipUp {
        0%   { transform: rotateX(0deg);  opacity: 1; }
        40%  { transform: rotateX(90deg); opacity: 0; }
        60%  { transform: rotateX(-90deg);opacity: 0; }
        100% { transform: rotateX(0deg);  opacity: 1; }
      }

      .rolodex-card.flip-down { animation: flipDown 0.4s ease-in-out; }
      .rolodex-card.flip-up   { animation: flipUp   0.4s ease-in-out; }

      /* wobble on land */
      @keyframes wobble {
        0%   { transform: rotate(0deg); }
        25%  { transform: rotate(1.5deg); }
        50%  { transform: rotate(-1deg); }
        75%  { transform: rotate(0.5deg); }
        100% { transform: rotate(0deg); }
      }
      .rolodex-card.wobble { animation: wobble 0.35s ease-out; }

      /* nav arrow buttons */
      .nav-btn { transition: all 0.15s; }
      .nav-btn:active { transform: scale(0.9); }

      /* collapsible section */
      .manage-body {
        display: grid;
        grid-template-rows: 0fr;
        transition: grid-template-rows 0.3s ease;
      }
      .manage-body.open {
        grid-template-rows: 1fr;
      }
      .manage-body > div {
        overflow: hidden;
      }

      /* counter pill */
      .counter-pill {
        background: #FFF8F0;
        border: 2px solid #222;
        font-variant-numeric: tabular-nums;
      }
    </style>
  </head>

  <body class="text-[#1a1a1a] antialiased">
    <main class="mx-auto max-w-2xl px-6 pt-16 pb-24">
      <!-- Top bar -->
      <div class="flex items-center">
        <a
          href="/"
          class="text-sm font-semibold text-[#1a1a1a]/40 hover:text-[#1a1a1a] transition-colors"
        >
          &larr; Home
        </a>
      </div>

      <!-- Header -->
      <header class="mt-10">
        <h1 class="text-5xl font-bold tracking-tight text-[#1a1a1a]">
          Idea Shuffler
        </h1>
        <p class="mt-2 text-[#1a1a1a]/50 text-lg">
          No ranking. No order. Just vibes.
        </p>
      </header>

      <!-- Rolodex Card -->
      <section class="mt-10">
        <div class="rolodex-wrapper">
          <div
            id="shuffleCard"
            class="rolodex-card rounded-2xl border-3 border-[#222] bg-white shadow-[4px_4px_0_#222]"
          >
            <div class="px-10 py-16">
              <div class="text-center min-h-[4.5rem] flex items-center justify-center">
                <p
                  id="idea"
                  class="text-2xl sm:text-3xl font-bold leading-snug tracking-tight text-[#1a1a1a]"
                >
                  Add a few ideas to get started.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Counter + Nav arrows -->
        <div class="mt-5 flex items-center justify-center gap-3">
          <button
            id="up"
            class="nav-btn h-11 w-11 rounded-full border-2 border-[#222] bg-[#FF6154] text-white text-lg font-bold shadow-[2px_2px_0_#222] hover:shadow-[3px_3px_0_#222] hover:translate-x-[-1px] hover:translate-y-[-1px]"
            aria-label="Previous idea"
          >
            &uarr;
          </button>
          <div id="counterPill" class="counter-pill rounded-full px-4 py-1.5 text-sm font-semibold text-[#1a1a1a]">
            0 of 0
          </div>
          <button
            id="down"
            class="nav-btn h-11 w-11 rounded-full border-2 border-[#222] bg-[#FF6154] text-white text-lg font-bold shadow-[2px_2px_0_#222] hover:shadow-[3px_3px_0_#222] hover:translate-x-[-1px] hover:translate-y-[-1px]"
            aria-label="Next idea"
          >
            &darr;
          </button>
        </div>

        <p class="mt-3 text-center text-xs text-[#1a1a1a]/35">
          Click the card, use arrows, or scroll.
        </p>
      </section>

      <!-- Collapsible Manage Section -->
      <section class="mt-14">
        <button
          id="toggleManage"
          class="flex w-full items-center justify-between rounded-xl border-2 border-[#222] bg-[#FFD93D] px-4 py-3 text-left shadow-[2px_2px_0_#222] transition-all hover:shadow-[3px_3px_0_#222] hover:translate-x-[-1px] hover:translate-y-[-1px]"
        >
          <span class="text-sm font-bold text-[#1a1a1a]">
            Manage ideas
            <span id="listCount" class="ml-1 text-[#1a1a1a]/60">(0)</span>
          </span>
          <svg
            id="chevron"
            class="h-4 w-4 text-[#1a1a1a] transition-transform duration-300"
            fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <div id="manageBody" class="manage-body">
          <div>
            <!-- Add idea -->
            <div class="mt-4 flex gap-3">
              <textarea
                id="newIdea"
                class="flex-1 rounded-xl border-2 border-dashed border-[#222]/30 bg-white px-4 py-3 text-sm leading-6 outline-none resize-none focus:border-[#FF6154] focus:border-solid transition-colors placeholder:text-[#1a1a1a]/30"
                placeholder="Type or paste an idea here..."
                rows="2"
                spellcheck="false"
              ></textarea>
              <button
                id="addSave"
                class="shrink-0 self-end rounded-xl border-2 border-[#222] bg-[#1a1a1a] px-5 py-3 text-sm font-bold text-white shadow-[2px_2px_0_#FF6154] hover:shadow-[3px_3px_0_#FF6154] hover:translate-x-[-1px] hover:translate-y-[-1px] transition-all disabled:opacity-40"
              >
                Add
              </button>
            </div>

            <!-- Idea list -->
            <div
              id="list"
              class="mt-4 space-y-2"
            ></div>

            <!-- Clear all -->
            <div id="clearRow" class="mt-4 hidden">
              <button
                id="clearAll"
                class="rounded-lg px-3 py-1.5 text-xs font-bold text-[#FF6154] hover:bg-[#FF6154]/10 transition-colors"
              >
                Clear all ideas
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      const LS_KEY = "idea-shuffler:v2";

      const elIdea = document.getElementById("idea")!;
      const elCard = document.getElementById("shuffleCard")!;
      const btnUp = document.getElementById("up")!;
      const btnDown = document.getElementById("down")!;
      const elCounter = document.getElementById("counterPill")!;

      const elNewIdea = document.getElementById("newIdea") as HTMLTextAreaElement;
      const btnAddSave = document.getElementById("addSave") as HTMLButtonElement;

      const elList = document.getElementById("list")!;
      const elListCount = document.getElementById("listCount")!;
      const btnClearAll = document.getElementById("clearAll")!;
      const elClearRow = document.getElementById("clearRow")!;

      const btnToggle = document.getElementById("toggleManage")!;
      const elManageBody = document.getElementById("manageBody")!;
      const elChevron = document.getElementById("chevron")!;

      let ideas: string[] = [];
      let currentIdx = -1;
      let flipping = false;

      // ---- Helpers ----

      function capitalize(str: string) {
        const s = str.trim();
        if (!s) return s;
        return s.charAt(0).toUpperCase() + s.slice(1);
      }

      function persist() {
        localStorage.setItem(LS_KEY, JSON.stringify({ ideas }));
      }

      function load() {
        try {
          const saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
          if (Array.isArray(saved.ideas)) ideas = saved.ideas;
        } catch (_) {}
      }

      function updateCounter() {
        if (ideas.length === 0) {
          elCounter.textContent = "0 of 0";
        } else {
          elCounter.textContent = `${currentIdx + 1} of ${ideas.length}`;
        }
      }

      // ---- AI condense ----

      async function condenseText(raw: string): Promise<string> {
        const trimmed = raw.trim();
        if (trimmed.split(/\s+/).length <= 8) {
          return capitalize(trimmed);
        }
        try {
          const res = await fetch("/api/condense", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: trimmed }),
          });
          if (!res.ok) throw new Error("API error");
          const { title } = await res.json();
          return title || capitalize(trimmed);
        } catch (_) {
          const first = trimmed.split(/[.!?]\s/)[0];
          return capitalize(first);
        }
      }

      // ---- Rolodex flip ----

      function flip(direction: "down" | "up", newText: string) {
        if (flipping) return;
        flipping = true;

        const cls = direction === "down" ? "flip-down" : "flip-up";
        elCard.classList.add(cls);

        setTimeout(() => {
          elIdea.textContent = newText;
          updateCounter();
        }, 180);

        setTimeout(() => {
          elCard.classList.remove(cls);
          // wobble on land
          elCard.classList.add("wobble");
          setTimeout(() => elCard.classList.remove("wobble"), 350);
          flipping = false;
        }, 400);
      }

      // ---- Render ----

      function render(animate: "down" | "up" | false = false) {
        const n = ideas.length;
        elListCount.textContent = `(${n})`;
        elClearRow.classList.toggle("hidden", n === 0);

        if (n === 0) {
          currentIdx = -1;
          const msg = "Add a few ideas to get started!";
          if (animate) flip(animate, msg);
          else { elIdea.textContent = msg; updateCounter(); }
          return;
        }

        if (currentIdx < 0 || currentIdx >= n) {
          currentIdx = Math.floor(Math.random() * n);
        }

        const newText = ideas[currentIdx];
        if (animate && elIdea.textContent !== newText) {
          flip(animate, newText);
        } else {
          elIdea.textContent = newText;
          updateCounter();
        }
      }

      function step(delta: number) {
        const n = ideas.length;
        if (n === 0) return;
        currentIdx = ((currentIdx + delta) % n + n) % n;
        render(delta > 0 ? "down" : "up");
      }

      // ---- Idea list ----

      function rebuildList() {
        elList.innerHTML = "";
        elListCount.textContent = `(${ideas.length})`;
        elClearRow.classList.toggle("hidden", ideas.length === 0);

        ideas.forEach((text, i) => {
          const row = document.createElement("div");
          row.className =
            "flex items-center gap-3 rounded-xl border-2 border-[#222]/15 bg-white px-4 py-3";

          const span = document.createElement("span");
          span.className = "flex-1 text-sm text-[#1a1a1a] truncate";
          span.textContent = text;

          const del = document.createElement("button");
          del.className =
            "shrink-0 rounded-lg px-3 py-1.5 text-xs font-bold text-[#FF6154] hover:bg-[#FF6154]/10 transition-colors";
          del.textContent = "Delete";
          del.addEventListener("click", () => {
            ideas.splice(i, 1);
            if (ideas.length === 0) {
              currentIdx = -1;
            } else if (currentIdx >= ideas.length) {
              currentIdx = 0;
            }
            persist();
            render("down");
            rebuildList();
          });

          row.appendChild(span);
          row.appendChild(del);
          elList.appendChild(row);
        });
      }

      async function addIdea(raw: string) {
        const trimmed = raw.trim();
        if (!trimmed) return;

        btnAddSave.disabled = true;
        btnAddSave.textContent = "...";

        const title = await condenseText(trimmed);

        btnAddSave.disabled = false;
        btnAddSave.textContent = "Add";

        if (!title) return;

        ideas.push(title);

        if (ideas.length === 1) {
          currentIdx = 0;
        }

        persist();
        render(ideas.length === 1 ? "down" : false);
        rebuildList();
      }

      // ---- Manage toggle ----

      let manageOpen = false;

      function toggleManage() {
        manageOpen = !manageOpen;
        elManageBody.classList.toggle("open", manageOpen);
        elChevron.style.transform = manageOpen ? "rotate(180deg)" : "";
      }

      // ---- Events ----

      elCard.addEventListener("click", () => step(1));
      btnUp.addEventListener("click", () => step(-1));
      btnDown.addEventListener("click", () => step(1));
      btnToggle.addEventListener("click", toggleManage);

      btnAddSave.addEventListener("click", () => {
        addIdea(elNewIdea.value);
        elNewIdea.value = "";
      });

      elNewIdea.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          addIdea(elNewIdea.value);
          elNewIdea.value = "";
        }
      });

      btnClearAll.addEventListener("click", () => {
        ideas = [];
        currentIdx = -1;
        persist();
        render("down");
        rebuildList();
      });

      // Keyboard nav
      window.addEventListener("keydown", (e) => {
        if (e.metaKey || e.ctrlKey || e.altKey) return;
        const tag = (document.activeElement?.tagName) || "";
        if (tag === "TEXTAREA" || tag === "INPUT") return;

        if (e.key === "ArrowUp") { e.preventDefault(); step(-1); }
        if (e.key === "ArrowDown" || e.key === " ") { e.preventDefault(); step(1); }
      });

      // Scroll
      let wheelLock = false;
      window.addEventListener("wheel", (e) => {
        if (ideas.length === 0 || wheelLock) return;
        if (Math.abs(e.deltaY) < 8) return;

        wheelLock = true;
        setTimeout(() => (wheelLock = false), 300);

        step(e.deltaY > 0 ? 1 : -1);
      }, { passive: true });

      // ---- Init ----
      load();

      if (ideas.length > 0) {
        currentIdx = Math.floor(Math.random() * ideas.length);
      }

      render();
      rebuildList();
    </script>
  </body>
</html>
